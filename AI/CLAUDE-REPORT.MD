# CLAUDE CODE ANALYSIS REPORT

**Project:** nhitomi (Kurumi)
**Analysis Date:** 2026-02-03
**Analyzer:** Claude Opus 4.5

---

## TABLE OF CONTENTS

1. [Executive Summary](#1-executive-summary)
2. [Project Overview](#2-project-overview)
3. [Technology Stack](#3-technology-stack)
4. [Project Structure](#4-project-structure)
5. [Architecture & Design Patterns](#5-architecture--design-patterns)
6. [Database Schema](#6-database-schema)
7. [Core Components](#7-core-components)
8. [Command System](#8-command-system)
9. [Doujin Source Clients](#9-doujin-source-clients)
10. [Interactive Message System](#10-interactive-message-system)
11. [Configuration System](#11-configuration-system)
12. [Localization & Internationalization](#12-localization--internationalization)
13. [External Integrations](#13-external-integrations)
14. [Data Flow Analysis](#14-data-flow-analysis)
15. [Error Handling & Monitoring](#15-error-handling--monitoring)
16. [Deployment & CI/CD](#16-deployment--cicd)
17. [File Inventory](#17-file-inventory)
18. [Dependencies](#18-dependencies)
19. [Security Considerations](#19-security-considerations)
20. [Recommendations](#20-recommendations)

---

## 1. EXECUTIVE SUMMARY

**nhitomi** is a feature-rich Discord bot application written in C# targeting .NET Core 2.2. The bot is designed for searching, browsing, and managing doujinshi (adult manga) from multiple online sources including nhentai.net and hitomi.la.

### Key Highlights

| Aspect | Details |
|--------|---------|
| **Language** | C# (.NET Core 2.2) |
| **Type** | Discord Bot Application |
| **License** | MIT License (2018-2019 chiya.dev) |
| **Version** | 3.4 (Heresta) |
| **Database** | MySQL (Production) / SQLite (Development) |
| **Primary Framework** | Discord.Net 2.1.1 |

### Core Capabilities

- Multi-source doujinshi search and browsing
- User collection management
- Interactive paginated messages with reaction controls
- Automated feed channels for doujin distribution
- Multi-language support (English, Indonesian, Korean)
- Download link generation

---

## 2. PROJECT OVERVIEW

### Purpose

nhitomi provides Discord users with commands to:
- Search and browse doujinshi from multiple sources
- View detailed information about individual works
- Manage personal collections of favorites
- Configure automatic feed channels in servers
- Generate download links for offline viewing
- Read/view pages directly in Discord

### Repository Information

| Field | Value |
|-------|-------|
| **Original Repository** | https://github.com/chiyadev/nhitomi |
| **Copyright** | 2018-2019 chiya.dev |
| **License** | MIT License |

### Version History

The project has undergone multiple iterations with codenames:
- Current: Version 3.4 "Heresta"

---

## 3. TECHNOLOGY STACK

### Core Framework

```
.NET Core 2.2 (netcoreapp2.2)
.NET Standard 2.0 (Core library)
```

### Primary Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Discord.Net | 2.1.1 | Discord API client library |
| Microsoft.AspNetCore | 2.2.0 | Web framework & hosting |
| Microsoft.EntityFrameworkCore | 2.2.4 | ORM / Database access |
| Pomelo.EntityFrameworkCore.MySql | 2.2.0 | MySQL provider |
| Microsoft.EntityFrameworkCore.Sqlite | 2.2.4 | SQLite provider (dev) |
| HtmlAgilityPack | 1.11.7 | HTML parsing for web scraping |
| Newtonsoft.Json | 12.0.2 | JSON serialization |
| SmartFormat.NET | 2.4.2 | String formatting/localization |
| System.Interactive.Async | 3.2.0 | Async LINQ extensions |

### Database

| Environment | Database | Provider |
|-------------|----------|----------|
| Production | MySQL | Pomelo.EntityFrameworkCore.MySql |
| Development | SQLite | Microsoft.EntityFrameworkCore.Sqlite |

### Build & Deployment

| Tool | Purpose |
|------|---------|
| AppVeyor | CI/CD pipeline |
| Docker | Containerization |
| Renovate | Automated dependency updates |

---

## 4. PROJECT STRUCTURE

```
Kurumi/
â”œâ”€â”€ nhitomi/                          # Main application project
â”‚   â”œâ”€â”€ Program.cs                    # Entry point
â”‚   â”œâ”€â”€ Startup.cs                    # DI configuration
â”‚   â”œâ”€â”€ AppSettings.cs                # Configuration models
â”‚   â”œâ”€â”€ GalleryUtility.cs             # URL parsing utilities
â”‚   â”œâ”€â”€ VersionHelper.cs              # Version information
â”‚   â”œâ”€â”€ AsyncEnumerableBrowser.cs     # Async enumeration helpers
â”‚   â”œâ”€â”€ DependencyUtility.cs          # DI utilities
â”‚   â”œâ”€â”€ ForcedGarbageCollector.cs     # Memory management
â”‚   â”‚
â”‚   â”œâ”€â”€ Discord/                      # Discord bot core
â”‚   â”‚   â”œâ”€â”€ DiscordService.cs         # Discord client wrapper
â”‚   â”‚   â”œâ”€â”€ CommandExecutor.cs        # Command parsing
â”‚   â”‚   â”œâ”€â”€ MessageHandlerService.cs  # Message events
â”‚   â”‚   â”œâ”€â”€ ReactionHandlerService.cs # Reaction events
â”‚   â”‚   â”œâ”€â”€ GalleryUrlDetector.cs     # URL detection
â”‚   â”‚   â”œâ”€â”€ FeedChannelUpdateService.cs
â”‚   â”‚   â”œâ”€â”€ GuildSettingsSyncService.cs
â”‚   â”‚   â”œâ”€â”€ GuildWelcomeMessageService.cs
â”‚   â”‚   â”œâ”€â”€ DiscordErrorReporter.cs
â”‚   â”‚   â”œâ”€â”€ LogHandlerService.cs
â”‚   â”‚   â”œâ”€â”€ StatusUpdateService.cs
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ Parsing/                  # Command parsing
â”‚   â”‚       â”œâ”€â”€ CommandAttribute.cs
â”‚   â”‚       â”œâ”€â”€ ModuleAttribute.cs
â”‚   â”‚       â”œâ”€â”€ OptionAttribute.cs
â”‚   â”‚       â”œâ”€â”€ BindingAttribute.cs
â”‚   â”‚       â””â”€â”€ CommandInfo.cs
â”‚   â”‚
â”‚   â”œâ”€â”€ Modules/                      # Command modules
â”‚   â”‚   â”œâ”€â”€ DoujinModule.cs           # Doujin commands
â”‚   â”‚   â”œâ”€â”€ CollectionModule.cs       # Collection commands
â”‚   â”‚   â”œâ”€â”€ FeedModule.cs             # Feed commands
â”‚   â”‚   â”œâ”€â”€ HelpModule.cs             # Help commands
â”‚   â”‚   â””â”€â”€ OptionModule.cs           # Options commands
â”‚   â”‚
â”‚   â”œâ”€â”€ Interactivity/                # Interactive messages
â”‚   â”‚   â”œâ”€â”€ InteractiveManager.cs
â”‚   â”‚   â”œâ”€â”€ InteractiveMessage.cs
â”‚   â”‚   â”œâ”€â”€ EmbedMessage.cs
â”‚   â”‚   â”œâ”€â”€ ListMessage.cs
â”‚   â”‚   â”œâ”€â”€ DoujinMessage.cs
â”‚   â”‚   â”œâ”€â”€ DoujinListMessage.cs
â”‚   â”‚   â”œâ”€â”€ DoujinListFromQueryMessage.cs
â”‚   â”‚   â”œâ”€â”€ DoujinListFromSourceMessage.cs
â”‚   â”‚   â”œâ”€â”€ CollectionMessage.cs
â”‚   â”‚   â”œâ”€â”€ CollectionListMessage.cs
â”‚   â”‚   â”œâ”€â”€ DownloadMessage.cs
â”‚   â”‚   â”œâ”€â”€ DoujinReadMessage.cs
â”‚   â”‚   â”œâ”€â”€ CommandHelpMessage.cs
â”‚   â”‚   â”œâ”€â”€ ErrorMessage.cs
â”‚   â”‚   â”œâ”€â”€ HelpMessage.cs
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ Triggers/                 # Reaction triggers
â”‚   â”‚       â”œâ”€â”€ ReactionTrigger.cs
â”‚   â”‚       â”œâ”€â”€ DeleteTrigger.cs
â”‚   â”‚       â”œâ”€â”€ DownloadTrigger.cs
â”‚   â”‚       â”œâ”€â”€ FavoriteTrigger.cs
â”‚   â”‚       â”œâ”€â”€ ReadTrigger.cs
â”‚   â”‚       â”œâ”€â”€ ListTrigger.cs
â”‚   â”‚       â””â”€â”€ ListJumpTrigger.cs
â”‚   â”‚
â”‚   â”œâ”€â”€ Globalization/                # Localization
â”‚   â”‚   â”œâ”€â”€ Localization.cs
â”‚   â”‚   â”œâ”€â”€ LocalizationDictionary.cs
â”‚   â”‚   â””â”€â”€ Languages/
â”‚   â”‚       â”œâ”€â”€ en.json               # English
â”‚   â”‚       â”œâ”€â”€ id.json               # Indonesian
â”‚   â”‚       â””â”€â”€ ko.json               # Korean
â”‚   â”‚
â”‚   â”œâ”€â”€ appsettings.json
â”‚   â”œâ”€â”€ appsettings.Development.json
â”‚   â””â”€â”€ nhitomi.csproj
â”‚
â”œâ”€â”€ nhitomi.Core/                     # Core library
â”‚   â”œâ”€â”€ Doujin.cs                     # Doujin entity
â”‚   â”œâ”€â”€ DoujinInfo.cs                 # DTO
â”‚   â”œâ”€â”€ Collection.cs                 # Collection entity
â”‚   â”œâ”€â”€ Tag.cs                        # Tag entity
â”‚   â”œâ”€â”€ Guild.cs                      # Guild entity
â”‚   â”œâ”€â”€ FeedChannel.cs                # Feed channel entity
â”‚   â”œâ”€â”€ CollectionSort.cs
â”‚   â”œâ”€â”€ Extensions.cs
â”‚   â”œâ”€â”€ HashUtility.cs
â”‚   â”œâ”€â”€ AtomicCounter.cs
â”‚   â”œâ”€â”€ IDoujinClient.cs
â”‚   â”œâ”€â”€ IHttpClient.cs
â”‚   â”œâ”€â”€ HttpClientWrapper.cs
â”‚   â”œâ”€â”€ IgnoredAttribute.cs
â”‚   â”œâ”€â”€ nhitomiDbContext.cs           # EF Core context
â”‚   â”œâ”€â”€ nhitomiSerializerSettings.cs
â”‚   â”‚
â”‚   â”œâ”€â”€ Clients/                      # Source clients
â”‚   â”‚   â”œâ”€â”€ IDoujinClient.cs
â”‚   â”‚   â”œâ”€â”€ ClientTester.cs
â”‚   â”‚   â”œâ”€â”€ nhentai/
â”‚   â”‚   â”‚   â”œâ”€â”€ nhentaiClient.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ nhentai82843.cs
â”‚   â”‚   â”‚   â”œâ”€â”€ nhentai250000.cs
â”‚   â”‚   â”‚   â””â”€â”€ nhentai273650.cs
â”‚   â”‚   â””â”€â”€ Hitomi/
â”‚   â”‚       â”œâ”€â”€ HitomiClient.cs
â”‚   â”‚       â”œâ”€â”€ Hitomi1422964.cs
â”‚   â”‚       â”œâ”€â”€ Hitomi1425272.cs
â”‚   â”‚       â””â”€â”€ Hitomi1425386.cs
â”‚   â”‚
â”‚   â”œâ”€â”€ Models/
â”‚   â”‚   â”œâ”€â”€ Doujin.cs
â”‚   â”‚   â”œâ”€â”€ DoujinMeta.cs
â”‚   â”‚   â”œâ”€â”€ DoujinSource.cs
â”‚   â”‚   â”œâ”€â”€ DoujinCollection.cs
â”‚   â”‚   â””â”€â”€ ModelBase.cs
â”‚   â”‚
â”‚   â”œâ”€â”€ Migrations/
â”‚   â”‚   â”œâ”€â”€ 20190610042252_MergeMigrations.cs
â”‚   â”‚   â””â”€â”€ nhitomiDbContextModelSnapshot.cs
â”‚   â”‚
â”‚   â””â”€â”€ nhitomi.Core.csproj
â”‚
â”œâ”€â”€ nhitomi.Core.UnitTests/           # Unit tests
â”‚   â”œâ”€â”€ TestUtils.cs
â”‚   â””â”€â”€ Clients/
â”‚       â””â”€â”€ ClientTests.cs
â”‚
â”œâ”€â”€ appveyor.yml                      # CI/CD config
â”œâ”€â”€ Dockerfile                        # Docker config
â”œâ”€â”€ renovate.json                     # Dependency automation
â”œâ”€â”€ nhitomi.sln                       # Solution file
â”œâ”€â”€ README.md
â”œâ”€â”€ nhitomi_README.md
â””â”€â”€ LICENSE
```

---

## 5. ARCHITECTURE & DESIGN PATTERNS

### Architectural Style

The application follows a **layered architecture** with clear separation of concerns:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DISCORD LAYER                      â”‚
â”‚  (Commands, Messages, Reactions, Events)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   SERVICE LAYER                      â”‚
â”‚  (Handlers, Managers, Executors)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   BUSINESS LAYER                     â”‚
â”‚  (Modules, Interactive System, Clients)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    DATA LAYER                        â”‚
â”‚  (DbContext, Entities, Repositories)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Design Patterns Used

| Pattern | Implementation | Location |
|---------|----------------|----------|
| **Dependency Injection** | Microsoft.Extensions.DependencyInjection | `Startup.cs` |
| **Repository Pattern** | IDatabase abstraction | `nhitomiDbContext.cs` |
| **Service Pattern** | IHostedService | All background services |
| **Factory Pattern** | DependencyUtility | `DependencyUtility.cs` |
| **Decorator Pattern** | DiscordContextWrapper | Discord context wrapping |
| **Observer Pattern** | Discord event handlers | Message/Reaction handlers |
| **State Pattern** | InteractiveMessage states | Interactivity system |
| **Strategy Pattern** | IDoujinClient implementations | Source clients |
| **Command Pattern** | Module/Command attributes | Command system |

### Dependency Injection Container

Services are registered in `Startup.ConfigureServices()`:

```csharp
// Core services
services.AddDbContext<nhitomiDbContext>();
services.AddSingleton<IDiscordClient>();
services.AddSingleton<InteractiveManager>();

// Hosted services (background tasks)
services.AddHostedService<MessageHandlerService>();
services.AddHostedService<ReactionHandlerService>();
services.AddHostedService<StatusUpdateService>();
services.AddHostedService<FeedChannelUpdateService>();
services.AddHostedService<GuildSettingsSyncService>();
```

---

## 6. DATABASE SCHEMA

### Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     GUILD       â”‚     â”‚   FEEDCHANNEL   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Id (PK)         â”‚â—„â”€â”€â”€â”€â”¤ GuildId (FK)    â”‚
â”‚ Language        â”‚     â”‚ Id (PK)         â”‚
â”‚ SearchFilter    â”‚     â”‚ LastDoujinId    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ WhitelistType   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ FEEDCHANNELTAG  â”‚
                        â”‚ (Join Table)    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     DOUJIN      â”‚â—„â”€â”€â”€â”€â”¤      TAG        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Id (PK)         â”‚     â”‚ Id (PK)         â”‚
â”‚ AccessId        â”‚     â”‚ AccessId        â”‚
â”‚ PrettyName      â”‚     â”‚ Type            â”‚
â”‚ OriginalName    â”‚     â”‚ Value           â”‚
â”‚ UploadTime      â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ ProcessTime     â”‚
â”‚ Source          â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SourceId        â”‚     â”‚   COLLECTION    â”‚
â”‚ PageCount       â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Data            â”‚â—„â”€â”€â”€â”€â”¤ Id (PK)         â”‚
â”‚ TagsDenormalizedâ”‚     â”‚ Name            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ OwnerId         â”‚
                        â”‚ Sort            â”‚
                        â”‚ SortDescending  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Entity Definitions

#### Doujin
Primary entity representing a doujinshi work.

| Column | Type | Description |
|--------|------|-------------|
| Id | int | Primary key |
| AccessId | Guid | Unique public identifier |
| PrettyName | string | English/romanized name |
| OriginalName | string | Original language name |
| UploadTime | DateTime | Upload timestamp |
| ProcessTime | DateTime | Processing timestamp |
| Source | string | Source identifier (nhentai, hitomi) |
| SourceId | string | Source-specific ID |
| PageCount | int | Number of pages |
| Data | string | Client-specific JSON data |
| TagsDenormalized | string | Flattened tags for search |

#### Tag
Metadata tags for doujins.

| Column | Type | Description |
|--------|------|-------------|
| Id | int | Primary key |
| AccessId | Guid | Unique public identifier |
| Type | TagType | Enum: Artist, Group, Scanlator, Language, Parody, Character, Category, Tag |
| Value | string | Tag value/name |

#### Collection
User-created collections.

| Column | Type | Description |
|--------|------|-------------|
| Id | int | Primary key |
| Name | string | Collection name |
| OwnerId | ulong | Discord user ID |
| Sort | CollectionSort | Sort criteria |
| SortDescending | bool | Sort direction |

#### Guild
Discord server settings.

| Column | Type | Description |
|--------|------|-------------|
| Id | ulong | Discord guild ID (primary key) |
| Language | string | Preferred language code |
| SearchQualityFilter | bool | Enable quality filtering |

#### FeedChannel
Automated feed channel configuration.

| Column | Type | Description |
|--------|------|-------------|
| Id | ulong | Discord channel ID (primary key) |
| GuildId | ulong | Parent guild ID |
| LastDoujinId | int? | Last sent doujin (tracking) |
| WhitelistType | WhitelistType | Any/All tag matching |

### Join Tables

| Table | Relationship |
|-------|--------------|
| TagRef | Doujin â†” Tag (many-to-many) |
| CollectionRef | Collection â†” Doujin (many-to-many) |
| FeedChannelTag | FeedChannel â†” Tag (many-to-many) |

---

## 7. CORE COMPONENTS

### 7.1 Entry Point (Program.cs)

The application entry point creates and runs the host:

```csharp
public static async Task Main(string[] args) =>
    await CreateHostBuilder(args).Build().RunAsync();

public static IHostBuilder CreateHostBuilder(string[] args) =>
    Host.CreateDefaultBuilder(args)
        .ConfigureWebHostDefaults(builder =>
            builder.UseStartup<Startup>());
```

### 7.2 Startup Configuration (Startup.cs)

Handles:
- Configuration loading (JSON files, environment variables, secrets)
- Service registration in DI container
- Database context setup
- Discord client initialization
- Background service registration

### 7.3 Discord Service (DiscordService.cs)

Wraps the Discord.Net client providing:
- Connection management
- Event subscription
- Client configuration
- Socket caching

### 7.4 Interactive Manager (InteractiveManager.cs)

Manages interactive messages:
- Tracks active interactive messages
- Routes reaction events to handlers
- Handles message expiration (1 hour timeout)
- Manages concurrent user interactions

### 7.5 Database Context (nhitomiDbContext.cs)

Entity Framework Core context:
- DbSet definitions for all entities
- Relationship configuration
- Index definitions
- Migration support

---

## 8. COMMAND SYSTEM

### Command Framework

The bot uses a custom reflection-based command framework with attributes:

```csharp
[Module("module")]
public class ExampleModule
{
    [Command("command", Alias = "c")]
    [Binding("[arg1] [arg2]")]
    public async Task<IInteractiveMessage> CommandAsync(
        string arg1,
        [Option] string arg2 = "default")
    {
        // Implementation
    }
}
```

### Command Parsing Pipeline

```
1. Message Received
       â”‚
       â–¼
2. Check Prefix (default: "n!")
       â”‚
       â–¼
3. Reflect Over Modules
       â”‚
       â–¼
4. Find Matching Command
       â”‚
       â–¼
5. Parse Arguments (Binding Pattern)
       â”‚
       â–¼
6. Resolve Dependencies
       â”‚
       â–¼
7. Invoke Command Method
       â”‚
       â–¼
8. Return Result to Discord
```

### Available Commands

#### DoujinModule

| Command | Alias | Description | Usage |
|---------|-------|-------------|-------|
| `get` | `g` | Get doujin info | `n!get nhentai 12345` |
| `from` | `f` | Browse source | `n!from nhentai` |
| `search` | `s` | Search doujins | `n!search "query"` |
| `download` | `dl` | Get download link | `n!download nhentai 12345` |
| `read` | `r` | Open reader | `n!read nhentai 12345` |

#### CollectionModule

| Command | Alias | Description | Usage |
|---------|-------|-------------|-------|
| `collections` | `c` | List collections | `n!collections` |
| `collection` | - | View/manage collection | `n!collection favs` |
| `collection add` | - | Add to collection | `n!collection favs add nhentai 12345` |
| `collection remove` | - | Remove from collection | `n!collection favs remove nhentai 12345` |
| `collection sort` | - | Sort collection | `n!collection favs sort name` |
| `collection delete` | - | Delete collection | `n!collection favs delete` |

#### HelpModule

| Command | Alias | Description |
|---------|-------|-------------|
| `help` | `h` | Show help |
| `debug` | - | Show debug stats |

#### OptionModule

| Command | Description |
|---------|-------------|
| `language` | Set language preference |
| `quality` | Toggle quality filter |

#### FeedModule

| Command | Description |
|---------|-------------|
| `feed` | Configure feed channels |

---

## 9. DOUJIN SOURCE CLIENTS

### Client Interface

```csharp
public interface IDoujinClient
{
    string Name { get; }
    string Url { get; }
    string IconUrl { get; }
    GalleryRegex GalleryRegex { get; }

    Task<DoujinInfo> GetAsync(string id);
    Task<IEnumerable<string>> EnumerateAsync(string startId = null);
    IEnumerable<string> PopulatePages(Doujin doujin);
    void InitializeImageRequest(Doujin doujin, HttpRequestMessage request);
}
```

### Implemented Clients

#### nhentaiClient

| Property | Value |
|----------|-------|
| **Source** | nhentai.net |
| **API Type** | JSON REST API |
| **Base URL** | `https://nhentai.net/api/galleries/` |
| **Features** | Pagination, search, metadata |

Implementation details:
- Uses JSON API for efficient data retrieval
- Handles rate limiting
- Generates CDN URLs for images

#### HitomiClient

| Property | Value |
|----------|-------|
| **Source** | hitomi.la |
| **API Type** | HTML scraping + custom format |
| **Base URL** | `https://hitomi.la/` |
| **Features** | NOZOMI index, CDN delivery |

Implementation details:
- HTML parsing with HtmlAgilityPack
- Uses NOZOMI binary index format
- Custom CDN URL generation logic
- JavaScript-style URL computation

### URL Detection (GalleryUtility)

The bot can detect doujin URLs in messages:

```
Supported Formats:
- Full URLs: nhentai.net/g/12345, hitomi.la/galleries/12345.html
- Short forms: nh/12345, hi/12345
- Direct IDs: 12345 (context-dependent)
```

### Test Cases

Each client has test cases for validation:

**nhentai:**
- ID 82843
- ID 250000
- ID 273650

**Hitomi:**
- ID 1422964
- ID 1425272
- ID 1425386

---

## 10. INTERACTIVE MESSAGE SYSTEM

### Overview

The interactive system enables rich, reactive Discord embeds with pagination and user interactions.

### Components

```
InteractiveManager
       â”‚
       â”œâ”€â”€ InteractiveMessage (base)
       â”‚         â”‚
       â”‚         â”œâ”€â”€ DoujinMessage
       â”‚         â”œâ”€â”€ DoujinListMessage
       â”‚         â”‚        â”œâ”€â”€ DoujinListFromQueryMessage
       â”‚         â”‚        â””â”€â”€ DoujinListFromSourceMessage
       â”‚         â”œâ”€â”€ CollectionMessage
       â”‚         â”œâ”€â”€ CollectionListMessage
       â”‚         â”œâ”€â”€ DownloadMessage
       â”‚         â”œâ”€â”€ DoujinReadMessage
       â”‚         â”œâ”€â”€ HelpMessage
       â”‚         â”œâ”€â”€ CommandHelpMessage
       â”‚         â””â”€â”€ ErrorMessage
       â”‚
       â””â”€â”€ ReactionTrigger (base)
                 â”‚
                 â”œâ”€â”€ ListTrigger (â—„ â–º)
                 â”œâ”€â”€ ListJumpTrigger
                 â”œâ”€â”€ DeleteTrigger
                 â”œâ”€â”€ DownloadTrigger
                 â”œâ”€â”€ FavoriteTrigger
                 â””â”€â”€ ReadTrigger
```

### Message Lifecycle

```
1. Command Executed
       â”‚
       â–¼
2. Create InteractiveMessage
       â”‚
       â–¼
3. Send to Discord
       â”‚
       â–¼
4. Add Reaction Triggers
       â”‚
       â–¼
5. Register with InteractiveManager
       â”‚
       â–¼
6. Wait for User Reactions
       â”‚
       â–¼
7. Handle Trigger Events
       â”‚
       â–¼
8. Update Message Content
       â”‚
       â–¼
9. Auto-expire after 1 hour
```

### Reaction Triggers

| Trigger | Emoji | Function |
|---------|-------|----------|
| ListTrigger | â—„ â–º | Navigate pages |
| ListJumpTrigger | ğŸ”¢ | Jump to page |
| DeleteTrigger | âŒ | Delete message |
| DownloadTrigger | ğŸ“¥ | Generate download |
| FavoriteTrigger | â­ | Add to favorites |
| ReadTrigger | ğŸ“– | Open reader |

---

## 11. CONFIGURATION SYSTEM

### Configuration Sources

1. `appsettings.json` - Base configuration
2. `appsettings.Development.json` - Development overrides
3. `appsecrets.json` - Secrets (not in source control)
4. Environment variables

### Configuration Structure

```json
{
  "logging": {
    "logLevel": {
      "Default": "Information",
      "Microsoft": "Warning"
    }
  },
  "discord": {
    "prefix": "n!",
    "token": "BOT_TOKEN_HERE",
    "botInvite": "https://discord.com/oauth2/...",
    "status": {
      "updateInterval": 10,
      "games": ["n!help | Version 3.4"]
    },
    "guild": {
      "guildId": 515395714264858653,
      "guildInvite": "https://discord.gg/...",
      "errorChannelId": 529695761449877504
    }
  },
  "http": {
    "userAgent": "nhitomi/3.4"
  },
  "feed": {
    "enabled": false
  }
}
```

### AppSettings Classes

| Class | Properties |
|-------|------------|
| `AppSettings` | Discord, Http, Feed |
| `DiscordSettings` | Prefix, Token, BotInvite, Status, Guild |
| `StatusSettings` | UpdateInterval, Games |
| `GuildSettings` | GuildId, GuildInvite, ErrorChannelId |
| `HttpSettings` | UserAgent, Proxy |
| `FeedSettings` | Enabled, UpdateInterval |

---

## 12. LOCALIZATION & INTERNATIONALIZATION

### Supported Languages

| Code | Language | File |
|------|----------|------|
| `en` | English | `Globalization/Languages/en.json` |
| `id` | Indonesian | `Globalization/Languages/id.json` |
| `ko` | Korean | `Globalization/Languages/ko.json` |

### Implementation

```csharp
// Get localization for current context
var l = context.GetLocalization();

// Use localized string with variables
var message = l["doujin.title", new { name = doujin.PrettyName }];
```

### String Format

Uses SmartFormat.NET for variable interpolation:

```json
{
  "doujin": {
    "title": "{name}",
    "info": "Pages: {pages} | Source: {source}",
    "notFound": "Doujin not found."
  }
}
```

### Language Selection

- Per-guild language preference stored in database
- Fallback to English if translation missing
- Admin command to change server language

---

## 13. EXTERNAL INTEGRATIONS

### Discord API

| Feature | Implementation |
|---------|----------------|
| WebSocket Connection | Discord.Net SocketClient |
| Message Handling | MessageReceived event |
| Reaction Handling | ReactionAdded event |
| Embed Messages | EmbedBuilder |
| Bot Status | SetGameAsync |

### Web Scraping

| Source | Method |
|--------|--------|
| nhentai.net | JSON API |
| hitomi.la | HTML + HtmlAgilityPack |

### HTTP Client

Custom `HttpClientWrapper` with:
- User-Agent configuration
- Proxy support
- Request initialization hooks
- Timeout handling

---

## 14. DATA FLOW ANALYSIS

### Search Flow

```
User: n!search "cute girls"
           â”‚
           â–¼
    CommandExecutor
           â”‚
           â–¼
   DoujinModule.SearchAsync()
           â”‚
           â–¼
   Create DoujinSearchArgs
           â”‚
           â–¼
   InteractiveManager.SendAsync()
           â”‚
           â–¼
   DoujinListFromQueryMessage
           â”‚
           â–¼
   Query Database (LIKE search)
           â”‚
           â–¼
   Build Embed with Results
           â”‚
           â–¼
   Send to Discord
           â”‚
           â–¼
   Register Reaction Triggers
```

### Collection Management Flow

```
User: n!collection favs add nhentai 12345
           â”‚
           â–¼
    CommandExecutor
           â”‚
           â–¼
   CollectionModule.AddAsync()
           â”‚
           â–¼
   Get/Create Collection
           â”‚
           â–¼
   Fetch Doujin from Database
           â”‚
           â–¼
   Create CollectionRef
           â”‚
           â–¼
   Save to Database
           â”‚
           â–¼
   Send Confirmation
```

### Feed Channel Flow

```
FeedChannelUpdateService (Background)
           â”‚
           â–¼
   Query New Doujins (since LastDoujinId)
           â”‚
           â–¼
   For Each FeedChannel:
           â”‚
           â”œâ”€â”€ Load Tag Whitelist
           â”‚
           â”œâ”€â”€ Filter by Tags (Any/All)
           â”‚
           â”œâ”€â”€ Send Matching Doujins
           â”‚
           â””â”€â”€ Update LastDoujinId
```

---

## 15. ERROR HANDLING & MONITORING

### Error Reporting

`DiscordErrorReporter` catches unhandled exceptions and:
1. Logs error details
2. Sends to designated error channel
3. Preserves stack traces
4. Includes context information

### Logging

```csharp
"logging": {
  "logLevel": {
    "Default": "Information",
    "Microsoft": "Warning",
    "Discord": "Warning"
  }
}
```

### Monitoring (Debug Command)

The `n!debug` command provides:

| Metric | Description |
|--------|-------------|
| Guild Count | Connected servers |
| Channel Count | Total channels |
| User Count | Total users |
| Handled Messages | Commands processed |
| Received Messages | Total messages |
| Handled Reactions | Reactions processed |
| Received Reactions | Total reactions |
| Interactive Count | Active interactive messages |
| Virtual Memory | Process memory |
| Working Set | Physical memory |
| Managed Memory | .NET heap |
| Framework | Runtime version |

### Counters

Thread-safe `AtomicCounter` class tracks:
- `HandledMessages`
- `ReceivedMessages`
- `HandledReactions`
- `ReceivedReactions`

---

## 16. DEPLOYMENT & CI/CD

### AppVeyor Configuration

```yaml
version: '{build}'
image: Visual Studio 2017

clone_depth: 1

install:
  - git submodule update --init --recursive

build_script:
  - dotnet build
```

### Docker Configuration

```dockerfile
# Build stage
FROM microsoft/dotnet:sdk AS build
WORKDIR /app
COPY . .
RUN dotnet publish -c Release -o out

# Runtime stage
FROM microsoft/dotnet:aspnetcore-runtime
WORKDIR /app
COPY --from=build /app/nhitomi/out .
EXPOSE 80
ENTRYPOINT ["dotnet", "nhitomi.dll"]
```

### Dependency Management

Renovate bot configured for automated updates:

```json
{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": ["config:base"]
}
```

---

## 17. FILE INVENTORY

### C# Source Files by Category

| Category | Count | Key Files |
|----------|-------|-----------|
| **Core Models** | 9 | Doujin.cs, Tag.cs, Collection.cs, Guild.cs, FeedChannel.cs |
| **Source Clients** | 8 | nhentaiClient.cs, HitomiClient.cs + test cases |
| **Discord Services** | 12 | DiscordService.cs, CommandExecutor.cs, handlers |
| **Command Modules** | 5 | DoujinModule.cs, CollectionModule.cs, etc. |
| **Interactivity** | 15 | InteractiveManager.cs, message types, triggers |
| **Database/EF** | 5 | nhitomiDbContext.cs, migrations |
| **Utilities** | 20+ | Various helper classes |
| **Tests** | 2 | ClientTests.cs, TestUtils.cs |

### Configuration Files

| File | Purpose |
|------|---------|
| nhitomi.sln | Visual Studio solution |
| nhitomi/nhitomi.csproj | Main project |
| nhitomi.Core/nhitomi.Core.csproj | Core library project |
| appveyor.yml | CI/CD configuration |
| Dockerfile | Container configuration |
| renovate.json | Dependency automation |
| appsettings.json | Application configuration |
| appsettings.Development.json | Development overrides |

### Localization Files

| File | Language |
|------|----------|
| en.json | English (default) |
| id.json | Indonesian |
| ko.json | Korean |

---

## 18. DEPENDENCIES

### NuGet Packages (nhitomi)

| Package | Version |
|---------|---------|
| Discord.Net | 2.1.1 |
| Microsoft.AspNetCore | 2.2.0 |
| Microsoft.AspNetCore.Hosting | 2.2.0 |
| Microsoft.EntityFrameworkCore.Design | 2.2.4 |
| Microsoft.Extensions.Configuration.* | 2.2.0 |
| Microsoft.Extensions.Hosting | 2.2.0 |

### NuGet Packages (nhitomi.Core)

| Package | Version |
|---------|---------|
| HtmlAgilityPack | 1.11.7 |
| Microsoft.EntityFrameworkCore | 2.2.4 |
| Microsoft.EntityFrameworkCore.Sqlite | 2.2.4 |
| Newtonsoft.Json | 12.0.2 |
| Pomelo.EntityFrameworkCore.MySql | 2.2.0 |
| SmartFormat.NET | 2.4.2 |
| System.Interactive.Async | 3.2.0 |

### NuGet Packages (Tests)

| Package | Version |
|---------|---------|
| Microsoft.NET.Test.Sdk | 16.0.1 |
| xunit | 2.4.1 |
| xunit.runner.visualstudio | 2.4.1 |

---

## 19. SECURITY CONSIDERATIONS

### Identified Concerns

| Area | Concern | Recommendation |
|------|---------|----------------|
| **Token Storage** | Discord token in config file | Use environment variables or secret manager |
| **SQL Injection** | EF Core parameterizes queries | Current implementation is safe |
| **Input Validation** | Command inputs need validation | Add input sanitization |
| **Rate Limiting** | No explicit rate limiting | Implement rate limiting for commands |
| **Permissions** | Guild admin checks needed | Verify permission checks on admin commands |
| **Data Exposure** | User collections are personal | Ensure collection privacy |

### Current Security Measures

- EF Core prevents SQL injection
- Discord.Net handles token security
- Environment-specific configuration
- Secrets file excluded from source control

---

## 20. RECOMMENDATIONS

### Code Quality

1. **Update .NET Version** - .NET Core 2.2 is end-of-life; upgrade to .NET 6+ or .NET 8
2. **Add Unit Tests** - Current test coverage is minimal
3. **Implement Logging** - Add structured logging with Serilog or similar
4. **Documentation** - Add XML documentation comments

### Architecture

1. **Implement CQRS** - Separate read/write operations for better scaling
2. **Add Caching** - Cache frequently accessed data (doujins, tags)
3. **Message Queue** - Use queue for feed distribution
4. **Health Checks** - Add health check endpoints

### Security

1. **Rate Limiting** - Implement per-user rate limits
2. **Audit Logging** - Log admin actions
3. **Permission System** - Formalize permission checks

### Operations

1. **Container Orchestration** - Consider Kubernetes deployment
2. **Monitoring** - Add Application Insights or Prometheus
3. **Backup Strategy** - Implement automated database backups
4. **Scaling** - Design for horizontal scaling

### Feature Additions

1. **More Sources** - Add additional doujin sources
2. **Improved Search** - Implement Elasticsearch for better search
3. **User Profiles** - Add user statistics and preferences
4. **Web Interface** - Consider adding a web dashboard

---

## APPENDIX A: GLOSSARY

| Term | Definition |
|------|------------|
| Doujin/Doujinshi | Self-published Japanese works, often manga |
| nhentai | Popular doujinshi hosting website |
| Hitomi | Alternative doujinshi hosting website |
| EF Core | Entity Framework Core - .NET ORM |
| Discord.Net | C# library for Discord API |
| Feed Channel | Auto-posting channel for new content |
| Interactive Message | Discord message with reaction controls |

---

## APPENDIX B: COMMAND QUICK REFERENCE

```
BROWSING
n!get <source> <id>     - View doujin details
n!from <source>         - Browse source
n!search <query>        - Search doujins
n!read <source> <id>    - Open reader
n!download <source> <id> - Get download link

COLLECTIONS
n!collections           - List your collections
n!collection <name>     - View collection
n!collection <name> add <source> <id>    - Add to collection
n!collection <name> remove <source> <id> - Remove from collection
n!collection <name> sort <field>         - Sort collection
n!collection <name> delete               - Delete collection

SETTINGS
n!language <code>       - Set language (en/id/ko)
n!quality               - Toggle quality filter

HELP
n!help                  - Show help
n!debug                 - Show debug stats
```

---

## APPENDIX C: ENVIRONMENT VARIABLES

| Variable | Description |
|----------|-------------|
| `ASPNETCORE_ENVIRONMENT` | Environment name (Development/Production) |
| `Discord__Token` | Discord bot token |
| `ConnectionStrings__Default` | Database connection string |

---

*Report generated by Claude Opus 4.5*
*Analysis completed: 2026-02-03*
